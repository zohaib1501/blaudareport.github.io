<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #e0f7ff;
    color: #003366;
    margin: 0;
    user-select: none;
    font-size: 11px;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  h2 { text-align: center; color: #0077cc; margin: 5px 0; font-size: 18px; }
  #lastUpdated { text-align: center; font-size: 10px; color: #004d80; margin: 2px 0; }
  select {
    padding: 3px 6px; font-size: 11px; border-radius: 4px; border: 1px solid #00bfff;
    background: #b3e5ff; color: #003366; margin-bottom: 6px;
  }

  .top-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; }
  .metric-box {
    flex: 0 0 32%;
    background: linear-gradient(135deg, #00bfff, #1ec5ff);
    border: 2px solid #00f0ff;
    padding: 12px;
    border-radius: 12px;
    text-align: center;
    font-weight: bold;
    color: #003366;
    box-shadow: 0 0 15px rgba(0, 240, 255, 0.9);
    /* IMPORTANT: no animation on the box itself to avoid overlap/page shift */
  }
  /* Animate only the text inside the boxes */
  .metric-box .title, .metric-box .agent { animation: textPop 2s infinite alternate; }
  @keyframes textPop { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
  .metric-box .title {
    font-size: 16px; font-weight: bold; text-shadow: 0 0 3px #00f0ff, 0 0 6px #00f0ff; margin-bottom: 6px;
  }
  .metric-box .agent { font-size: 14px; margin: 3px 0; text-shadow: 0 0 2px #ffffff, 0 0 4px #00bfff; }

  .shift-container { display: flex; justify-content: space-between; gap: 6px; flex: 1 1 auto; overflow: hidden; }
  .shift-table {
    background: #b3e5ff; border-radius: 6px; padding: 6px; flex: 1; min-width: 45%;
    box-shadow: 0 0 8px #00bfff88; text-align: center; display: flex; flex-direction: column; height: 100%;
    color: #003366; overflow: hidden;
  }
  .shift-table h3 { margin: 3px 0 6px; font-size: 13px; color: #0077cc; }
  table { width: 100%; border-collapse: collapse; font-size: 11px; background: #e6f7ff; flex: 1 1 auto; color: #003366; }
  thead th { background: #00bfff; padding: 4px; font-size: 11px; color: #003366; cursor: pointer; border-radius: 4px; }
  tbody td { padding: 3px 2px; text-align: center; border-bottom: 1px solid #00aaff; }
  tbody tr:nth-child(odd) { background-color: #cceeff; }
  tbody tr:last-child { background-color: #00bfff; font-weight: bold; color: #ffffff; }
  tbody tr:hover { background-color: #99e6ff; }

  /* Password Screen */
  #passwordScreen {
    display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #e0f7ff;
  }
  #passwordScreen input { padding: 5px; margin: 5px; border-radius: 4px; border: 1px solid #00bfff; }
  #passwordScreen button { padding: 5px 10px; border: none; background: #00bfff; color: #003366; font-weight: bold; cursor: pointer; border-radius: 4px; }
  #errorMsg { color: red; font-size: 12px; margin-top: 5px; }
</style>
</head>
<body>
<!-- Password Gate -->
<div id="passwordScreen">
  <h2>Enter Password</h2>
  <input type="password" id="passwordInput" placeholder="Password">
  <label><input type="checkbox" id="showPass"> Show Password</label>
  <button id="passwordBtn">Submit</button>
  <div id="errorMsg"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h2>Agent Dashboard</h2>
  <div id="lastUpdated"></div>
  <div style="text-align:center;">
    <select id="monthDropdown"></select>
    <select id="quarterDropdown"></select>
  </div>

  <div class="top-row">
    <div id="topSok" class="metric-box"></div>
    <div id="topProfit" class="metric-box"></div>
    <div id="topCalls" class="metric-box"></div>
  </div>

  <div class="shift-container">
    <div class="shift-table">
      <h3>Morning Shift</h3>
      <div id="morningTable" style="flex:1 1 auto; overflow:auto;"></div>
    </div>
    <div class="shift-table">
      <h3>Night Shift</h3>
      <div id="nightTable" style="flex:1 1 auto; overflow:auto;"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyYD7X2tEKE1YJZU8pEF1KNtW43dMh0Kg-kRr1NV7u5mJZnSBZq_7p6OBCb3X322z10ReriXHngSRq/pub?gid=1105455398&single=true&output=csv";
const PASSWORD = "blauda123";

/* ===== STATE ===== */
let allData = [], headers = [];
let currentMonthKey = ""; // 'YYYY-MM' key
let currentQuarter = "";  // 'Q1'...'Q4' or 'ALL_Q'

/* ===== PASSWORD GATE ===== */
document.getElementById('showPass').addEventListener('change', e => {
  document.getElementById('passwordInput').type = e.target.checked ? 'text' : 'password';
});
document.getElementById('passwordBtn').addEventListener('click', checkPassword);
document.getElementById('passwordInput').addEventListener('keydown', e => { if (e.key === 'Enter') checkPassword(); });

function checkPassword() {
  const inputPass = document.getElementById('passwordInput').value;
  if (inputPass === PASSWORD) {
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadData();
  } else {
    document.getElementById('errorMsg').textContent = 'Incorrect password!';
  }
}

/* ===== LOAD CSV ===== */
async function loadData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  processCSV(text);
  document.getElementById('lastUpdated').textContent = "Last updated: " + new Date().toLocaleString();
}

function parseCSVLine(line) {
  const out = []; let v = "", q = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"' && line[i+1] === '"') { v += '"'; i++; }
    else if (c === '"') { q = !q; }
    else if (c === ',' && !q) { out.push(v.trim()); v = ""; }
    else { v += c; }
  }
  out.push(v.trim());
  return out;
}

function processCSV(text) {
  const lines = text.trim().split('\n').map(parseCSVLine);
  headers = lines[0].map(h => h.trim());
  allData = lines.slice(1);

  populateFilters();   // sets currentMonthKey to latest month
  attachFilterHandlers();
  displayData();
}

/* ===== DATE HELPERS (robust for 1-Oct-24, 10/1/2024, or Excel serials) ===== */
function excelSerialToDate(val) {
  const n = Number(val);
  if (!isNaN(n) && n > 59) { // ignore Excel's 1900 leap bug range
    const ms = (n - 25569) * 86400 * 1000; // days since 1970-01-01
    return new Date(ms);
  }
  return null;
}
function parseMonthValue(v) {
  if (v == null || v === "") return null;

  // Try Excel serial first
  const dSerial = excelSerialToDate(v);
  if (dSerial && !isNaN(dSerial)) return dSerial;

  // Try native Date parsing
  const dNative = new Date(v);
  if (!isNaN(dNative)) return dNative;

  // Try dd-MMM-yy or d-MMM-yy (e.g., 1-Oct-24)
  const m = String(v).trim().match(/^(\d{1,2})[-/ ]([A-Za-z]{3,})[-/ ](\d{2,4})$/);
  if (m) {
    const day = parseInt(m[1],10);
    const monName = m[2].slice(0,3).toLowerCase();
    const yr = parseInt(m[3],10);
    const monthIdx = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(monName);
    const fullYear = yr < 100 ? 2000 + yr : yr;
    if (monthIdx >= 0) return new Date(fullYear, monthIdx, day);
  }
  return null; // give up
}
function yyyymm(d) {
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
}
function label_mmmYY(d) {
  return d.toLocaleString('en-US', { month:'short', year:'2-digit' });
}

/* ===== FILTERS ===== */
function populateFilters() {
  const idxMonth = headers.indexOf("Month");
  const idxQuarter = headers.indexOf("Quarters");

  // Build unique months keyed by yyyymm
  const monthMap = new Map(); // key -> {key, date}
  const quarterSet = new Set();

  allData.forEach(r => {
    const md = parseMonthValue(r[idxMonth]);
    if (md && !isNaN(md)) {
      const key = yyyymm(md);
      if (!monthMap.has(key)) monthMap.set(key, { key, date: md });
    }
    if (r[idxQuarter]) quarterSet.add(r[idxQuarter]);
  });

  // Sort months DESC by actual date
  const months = Array.from(monthMap.values()).sort((a,b) => b.date - a.date);

  // Populate Month dropdown: All Months + mmm-yy items (values are yyyymm keys)
  const monthDD = document.getElementById('monthDropdown');
  monthDD.innerHTML = `<option value="">All Months</option>` +
    months.map(m => `<option value="${m.key}">${label_mmmYY(m.date)}</option>`).join('');

  // Default to latest month (first in DESC), e.g., Aug-25
  if (months.length) {
    monthDD.value = months[0].key;
    currentMonthKey = months[0].key;
  } else {
    // no months parsed; leave at All Months
    currentMonthKey = "";
  }

  // Populate Quarter dropdown: blank (Select) + All Quarters + Q1..Q4 present in CSV
  const quarterDD = document.getElementById('quarterDropdown');
  const quarters = Array.from(quarterSet).filter(Boolean).sort(); // e.g., ["Q1","Q2","Q3","Q4"]
  quarterDD.innerHTML =
    `<option value="">Select Quarter</option>` +
    `<option value="ALL_Q">All Quarters</option>` +
    quarters.map(q => `<option value="${q}">${q}</option>`).join('');
  quarterDD.value = ""; // blank by default to respect "month selected -> quarter blank"
}

function attachFilterHandlers() {
  const monthDD = document.getElementById('monthDropdown');
  const quarterDD = document.getElementById('quarterDropdown');

  monthDD.addEventListener('change', e => {
    currentMonthKey = e.target.value;         // yyyymm or ""
    if (currentMonthKey) {                    // month chosen -> blank out quarter
      quarterDD.value = "";
      currentQuarter = "";
    }
    displayData();
  });

  quarterDD.addEventListener('change', e => {
    currentQuarter = e.target.value;          // "", "ALL_Q", "Q1".."Q4"
    if (currentQuarter) {                     // quarter chosen -> blank out month
      monthDD.value = "";
      currentMonthKey = "";
    }
    displayData();
  });
}

/* ===== RENDERING ===== */
function displayData() {
  const idx = {
    quarter: headers.indexOf("Quarters"),
    month: headers.indexOf("Month"),
    agent: headers.indexOf("Sales Agent"),
    shift: headers.indexOf("Shift"),
    sok: headers.indexOf("SOK Count"),
    reserved: headers.indexOf("Reserved Count"),
    calls: headers.indexOf("Total Calls"),
    talk: headers.indexOf("Total Talktime"),
    profit: headers.indexOf("Estimated SOK Profit")
  };

  let rows = allData;

  // Apply Month filter (by month-year key)
  if (currentMonthKey) {
    rows = rows.filter(r => {
      const d = parseMonthValue(r[idx.month]);
      return d && yyyymm(d) === currentMonthKey;
    });
  }

  // Apply Quarter filter (from CSV), ignore when "ALL_Q"
  if (currentQuarter && currentQuarter !== "ALL_Q") {
    rows = rows.filter(r => (r[idx.quarter] || "") === currentQuarter);
  }

  // Group by shift & agent; compute totals
  const grouped = { morning: {}, night: {} };
  const top = {}; // by agent across both shifts

  rows.forEach(r => {
    const agent = r[idx.agent];
    const shiftRaw = (r[idx.shift] || "").toLowerCase();
    const shift = shiftRaw.includes("morning") ? "morning" : "night";

    const sok = +r[idx.sok] || 0;
    const reserved = +r[idx.reserved] || 0;
    const calls = +r[idx.calls] || 0;
    const profit = +r[idx.profit] || 0;

    // talktime might be HH:MM:SS or MM:SS or numeric seconds
    let talk = 0;
    const rawTalk = (r[idx.talk] || "").toString();
    if (rawTalk.includes(":")) {
      const t = rawTalk.split(":").map(Number);
      talk = t.length === 3 ? (t[0]*3600 + t[1]*60 + t[2]) : (t[0]*60 + t[1]);
    } else {
      talk = +rawTalk || 0;
    }

    if (!grouped[shift][agent]) grouped[shift][agent] = { agent, sokTotal:0, reservedTotal:0, callsTotal:0, talkTotal:0, profitTotal:0 };
    const g = grouped[shift][agent];
    g.sokTotal += sok;
    g.reservedTotal += reserved;
    g.callsTotal += calls;
    g.talkTotal += talk;
    g.profitTotal += profit;

    if (!top[agent]) top[agent] = { sokTotal:0, callsTotal:0, profitTotal:0 };
    top[agent].sokTotal += sok;
    top[agent].callsTotal += calls;
    top[agent].profitTotal += profit;
  });

  renderShift(Object.values(grouped.morning), document.getElementById('morningTable'));
  renderShift(Object.values(grouped.night), document.getElementById('nightTable'));
  renderTop(top);
}

function renderShift(data, container) {
  const totals = { sokTotal:0, reservedTotal:0, callsTotal:0, talkTotal:0, profitTotal:0 };
  data.forEach(d => { for (const k in totals) totals[k] += d[k]; });
  data.push({ agent: "Grand Total", ...totals });

  const headersRow = ["Sales Agent","SOK Count","Reserved Count","Total Calls","Total Talktime","Estimated SOK Profit"];
  let html = "<table><thead><tr>" + headersRow.map(h=>`<th>${h}</th>`).join('') + "</tr></thead><tbody>";
  data.forEach(d => {
    html += `<tr>
      <td data-value="${d.agent}">${d.agent}</td>
      <td data-value="${d.sokTotal}">${d.sokTotal}</td>
      <td data-value="${d.reservedTotal}">${d.reservedTotal}</td>
      <td data-value="${d.callsTotal}">${d.callsTotal}</td>
      <td data-value="${d.talkTotal}">${formatTime(d.talkTotal)}</td>
      <td data-value="${Math.round(d.profitTotal)}">¥${Math.round(d.profitTotal)}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
  enableSorting(container);
}

function renderTop(agg) {
  function boxHtml(title, key) {
    const top3 = Object.entries(agg)
      .map(([agent, v]) => ({ agent, value: v[key] || 0 }))
      .sort((a,b) => b.value - a.value)
      .slice(0, 3);
    return `<div><div class="title">${title}</div>${top3.map(t=>`<div class="agent">${t.agent}: ${Math.round(t.value)}</div>`).join("")}</div>`;
  }
  document.getElementById('topSok').innerHTML = boxHtml("Highest SOK - Top3","sokTotal");
  document.getElementById('topProfit').innerHTML = boxHtml("Highest Profit - Top3","profitTotal");
  document.getElementById('topCalls').innerHTML = boxHtml("Highest Calls - Top3","callsTotal");
}

function enableSorting(container) {
  const table = container.querySelector("table");
  if (!table) return;
  const tbody = table.querySelector("tbody");
  const ths = table.querySelectorAll("th");
  ths.forEach((th, idx) => {
    let asc = true;
    th.onclick = () => {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const totalRow = rows.pop(); // keep Grand Total at bottom
      rows.sort((a,b) => {
        const aVal = a.cells[idx].dataset.value || a.cells[idx].innerText;
        const bVal = b.cells[idx].dataset.value || b.cells[idx].innerText;
        const aNum = parseFloat(String(aVal).replace(/[^0-9.-]/g,""));
        const bNum = parseFloat(String(bVal).replace(/[^0-9.-]/g,""));
        if (!isNaN(aNum) && !isNaN(bNum)) return asc ? aNum - bNum : bNum - aNum;
        return asc ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
      });
      tbody.innerHTML = "";
      rows.forEach(r => tbody.appendChild(r));
      tbody.appendChild(totalRow);
      asc = !asc;
    };
  });
}

function formatTime(sec) {
  if (!sec) return "00:00";
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  return h ? `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`
           : `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
</script>
</body>
</html>
