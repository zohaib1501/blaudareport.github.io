<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<style>
  html, body {
    overflow-x: hidden;
  }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #e0f7ff;
    color: #003366;
    margin: 0;
    font-size: 11px;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  h2 { text-align: center; margin: 5px 0; font-size: 18px; color: #0077cc; }
  #lastUpdated { text-align: center; font-size: 10px; color: #004d80; margin: 2px 0; }
  select { padding: 3px 6px; font-size: 11px; border-radius: 4px; border: 1px solid #00bfff; background: #b3e5ff; margin-bottom: 6px; }

  .top-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; }
  .metric-box {
    flex: 0 0 32%;
    background: linear-gradient(135deg, #00bfff, #1ec5ff);
    border: 2px solid #00f0ff;
    padding: 12px;
    border-radius: 12px;
    text-align: center;
    font-weight: bold;
    color: #003366;
    box-shadow: 0 0 15px rgba(0, 240, 255, 0.9);
  }
  .metric-box .title, .metric-box .agent {
    animation: textPop 2s infinite alternate;
    transform-origin: center;
    display: inline-block;
  }
  @keyframes textPop { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }
  .metric-box .title {
    font-size: 16px; margin-bottom: 6px;
  }
  .metric-box .agent { font-size: 14px; margin: 3px 0; }

  .shift-container { display: flex; justify-content: space-between; gap: 6px; flex: 1 1 auto; overflow: hidden; }
  .shift-table { background: #b3e5ff; border-radius: 6px; padding: 6px; flex: 1; min-width: 45%; box-shadow: 0 0 8px #00bfff88; text-align: center; display: flex; flex-direction: column; height: 100%; }
  table { width: 100%; border-collapse: collapse; font-size: 11px; background: #e6f7ff; flex: 1 1 auto; }
  thead th { background: #00bfff; padding: 4px; font-size: 11px; cursor: pointer; border-radius: 4px; }
  tbody td { padding: 3px 2px; text-align: center; border-bottom: 1px solid #00aaff; }
  tbody tr:nth-child(odd) { background-color: #cceeff; }
  tbody tr:last-child { background-color: #00bfff; font-weight: bold; color: #ffffff; }

  #passwordScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #e0f7ff; }
  #passwordScreen input { padding: 5px; margin: 5px; border-radius: 4px; border: 1px solid #00bfff; }
  #passwordScreen button { padding: 5px 10px; border: none; background: #00bfff; color: #003366; font-weight: bold; cursor: pointer; border-radius: 4px; }
  #errorMsg { color: red; font-size: 12px; margin-top: 5px; }
</style>
</head>
<body>
<div id="passwordScreen">
  <h2>Enter Password</h2>
  <input type="password" id="passwordInput" placeholder="Password">
  <label><input type="checkbox" id="showPass"> Show Password</label>
  <button id="passwordBtn">Submit</button>
  <div id="errorMsg"></div>
</div>

<div id="dashboard" style="display:none;">
  <h2>Agent Dashboard</h2>
  <div id="lastUpdated"></div>
  <div style="text-align:center;">
    <select id="monthDropdown"></select>
    <select id="quarterDropdown"></select>
  </div>
  <div class="top-row">
    <div id="topSok" class="metric-box"></div>
    <div id="topProfit" class="metric-box"></div>
    <div id="topCalls" class="metric-box"></div>
  </div>
  <div class="shift-container">
    <div class="shift-table"><h3>Morning Shift</h3><div id="morningTable" style="flex:1 1 auto; overflow:auto;"></div></div>
    <div class="shift-table"><h3>Night Shift</h3><div id="nightTable" style="flex:1 1 auto; overflow:auto;"></div></div>
  </div>
</div>

<script>
const CSV_URL = "YOUR_CSV_URL";
const PASSWORD = "blauda123";

let allData = [], headers = [];
let currentMonthKey = "", currentQuarter = "";

document.getElementById('showPass').addEventListener('change', e => {
  document.getElementById('passwordInput').type = e.target.checked ? 'text' : 'password';
});
document.getElementById('passwordBtn').addEventListener('click', checkPassword);
document.getElementById('passwordInput').addEventListener('keydown', e => { if (e.key === 'Enter') checkPassword(); });

function checkPassword() {
  if (document.getElementById('passwordInput').value === PASSWORD) {
    document.getElementById('passwordScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadData();
  } else {
    document.getElementById('errorMsg').textContent = 'Incorrect password!';
  }
}

async function loadData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  processCSV(text);
  document.getElementById('lastUpdated').textContent = "Last updated: " + new Date().toLocaleString();
}

function parseCSVLine(line) {
  const out = []; let v = "", q = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"' && line[i+1] === '"') { v += '"'; i++; }
    else if (c === '"') { q = !q; }
    else if (c === ',' && !q) { out.push(v.trim()); v = ""; }
    else { v += c; }
  }
  out.push(v.trim());
  return out;
}

function processCSV(text) {
  const lines = text.trim().split('\n').map(parseCSVLine);
  headers = lines[0].map(h => h.trim());
  allData = lines.slice(1);
  populateFilters();
  attachFilterHandlers();
  displayData();
}

function excelSerialToDate(val) {
  const n = Number(val);
  if (!isNaN(n) && n > 59) {
    return new Date((n - 25569) * 86400 * 1000);
  }
  return null;
}
function parseMonthValue(v) {
  const dSerial = excelSerialToDate(v);
  if (dSerial) return dSerial;
  const dNative = new Date(v);
  return !isNaN(dNative) ? dNative : null;
}
function yyyymm(d) { return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0"); }
function label_mmmYY(d) { return d.toLocaleString('en-US', { month:'short', year:'2-digit' }); }

function populateFilters() {
  const idxMonth = headers.indexOf("Month");
  const idxQuarter = headers.indexOf("Quarters");
  const monthMap = new Map();
  const quarterSet = new Set();
  allData.forEach(r => {
    const md = parseMonthValue(r[idxMonth]);
    if (md) monthMap.set(yyyymm(md), md);
    if (r[idxQuarter]) quarterSet.add(r[idxQuarter]);
  });
  const months = Array.from(monthMap.entries()).sort((a,b) => b[1] - a[1]);
  const monthDD = document.getElementById('monthDropdown');
  monthDD.innerHTML = `<option value="">All Months</option>` +
    months.map(([k,d]) => `<option value="${k}">${label_mmmYY(d)}</option>`).join('');
  if (months.length) { monthDD.value = months[0][0]; currentMonthKey = months[0][0]; }
  const quarterDD = document.getElementById('quarterDropdown');
  const quarters = Array.from(quarterSet).sort();
  quarterDD.innerHTML = `<option value="">Select Quarter</option><option value="ALL_Q">All Quarters</option>` +
    quarters.map(q => `<option value="${q}">${q}</option>`).join('');
}
function attachFilterHandlers() {
  document.getElementById('monthDropdown').addEventListener('change', e => {
    currentMonthKey = e.target.value; if (currentMonthKey) currentQuarter = "";
    displayData();
  });
  document.getElementById('quarterDropdown').addEventListener('change', e => {
    currentQuarter = e.target.value; if (currentQuarter) currentMonthKey = "";
    displayData();
  });
}

function displayData() {
  const idx = {
    quarter: headers.indexOf("Quarters"),
    month: headers.indexOf("Month"),
    agent: headers.indexOf("Sales Agent"),
    shift: headers.indexOf("Shift"),
    sok: headers.indexOf("SOK Count"),
    reserved: headers.indexOf("Reserved Count"),
    calls: headers.indexOf("Total Calls"),
    talk: headers.indexOf("Total Talktime"),
    profit: headers.indexOf("Estimated SOK Profit")
  };
  let rows = allData;
  if (currentMonthKey) {
    rows = rows.filter(r => { const d = parseMonthValue(r[idx.month]); return d && yyyymm(d) === currentMonthKey; });
  }
  if (currentQuarter && currentQuarter !== "ALL_Q") {
    rows = rows.filter(r => r[idx.quarter] === currentQuarter);
  }
  const grouped = { morning: {}, night: {} };
  const top = {};
  rows.forEach(r => {
    const agent = r[idx.agent];
    const shift = (r[idx.shift] || "").toLowerCase().includes("morning") ? "morning" : "night";
    const sok = +r[idx.sok] || 0, reserved = +r[idx.reserved] || 0, calls = +r[idx.calls] || 0, profit = +r[idx.profit] || 0;
    let talk = 0; if (r[idx.talk]) { const t = r[idx.talk].split(":").map(Number); talk = t.length===3?(t[0]*3600+t[1]*60+t[2]):(t[0]*60+t[1]); }
    if (!grouped[shift][agent]) grouped[shift][agent] = { agent, sokTotal:0, reservedTotal:0, callsTotal:0, talkTotal:0, profitTotal:0 };
    grouped[shift][agent].sokTotal += sok;
    grouped[shift][agent].reservedTotal += reserved;
    grouped[shift][agent].callsTotal += calls;
    grouped[shift][agent].talkTotal += talk;
    grouped[shift][agent].profitTotal += profit;
    if (!top[agent]) top[agent] = { sokTotal:0, callsTotal:0, profitTotal:0 };
    top[agent].sokTotal += sok; top[agent].callsTotal += calls; top[agent].profitTotal += profit;
  });
  renderShift(Object.values(grouped.morning), document.getElementById('morningTable'));
  renderShift(Object.values(grouped.night), document.getElementById('nightTable'));
  renderTop(top);
}

function renderShift(data, container) {
  const totals = { sokTotal:0, reservedTotal:0, callsTotal:0, talkTotal:0, profitTotal:0 };
  data.forEach(d => { for (let k in totals) totals[k] += d[k]; });
  data.push({ agent: "Grand Total", ...totals });
  const headersRow = ["Sales Agent","SOK Count","Reserved Count","Total Calls","Total Talktime","Estimated SOK Profit"];
  let html = "<table><thead><tr>" + headersRow.map(h=>`<th>${h}</th>`).join('') + "</tr></thead><tbody>";
  data.forEach(d => {
    html += `<tr>
      <td>${d.agent}</td>
      <td>${d.sokTotal}</td>
      <td>${d.reservedTotal}</td>
      <td>${d.callsTotal}</td>
      <td>${formatTime(d.talkTotal)}</td>
      <td>Â¥${Math.round(d.profitTotal)}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
}

function renderTop(agg) {
  function boxHtml(title, key) {
    const top3 = Object.entries(agg)
      .map(([agent, v]) => ({ agent, value: v[key] || 0 }))
      .sort((a,b) => b.value - a.value)
      .slice(0, 3);
    return `<div class="title">${title}</div>` +
           top3.map(t => `<div class="agent">${t.agent}: ${Math.round(t.value)}</div>`).join("");
  }
  document.getElementById('topSok').innerHTML = boxHtml("Highest SOK - Top3","sokTotal");
  document.getElementById('topProfit').innerHTML = boxHtml("Highest Profit - Top3","profitTotal");
  document.getElementById('topCalls').innerHTML = boxHtml("Highest Calls - Top3","callsTotal");
}

function formatTime(sec) {
  if (isNaN(sec) || sec <= 0) return "00:00";
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  return [h,m,s].map(v=>String(v).padStart(2,"0")).join(":");
}
</script>
</body>
</html>
