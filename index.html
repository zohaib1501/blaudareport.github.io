<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #e0f7ff;
      color: #003366;
      margin: 0;
      user-select: none;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    h2 {
      text-align: center;
      color: #0077cc;
      margin: 5px 0;
      font-size: 18px;
    }

    #lastUpdated {
      text-align: center;
      font-size: 10px;
      color: #004d80;
      margin: 2px 0;
    }

    select {
      padding: 3px 6px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #00bfff;
      background: #b3e5ff;
      color: #003366;
      margin-bottom: 6px;
    }

    .top-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .metric-box {
      flex: 0 0 32%;
      background: linear-gradient(135deg, #00bfff, #1ec5ff);
      border: 2px solid #00f0ff;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      color: #003366;
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.9);
      position: relative;
      overflow: hidden;
      animation: pop 2s infinite alternate;
    }

    .metric-box:nth-child(2) {
      animation-delay: 0.3s;
    }

    .metric-box:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes pop {
      0% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 240, 255, 0.7); }
      50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 240, 255, 1); }
      100% { transform: scale(1); box-shadow: 0 0 15px rgba(0, 240, 255, 0.7); }
    }

    .metric-box .title {
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 0 3px #00f0ff, 0 0 6px #00f0ff;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }

    .metric-box .agent {
      font-size: 14px;
      margin: 3px 0;
      text-shadow: 0 0 2px #ffffff, 0 0 4px #00bfff;
    }

    .shift-container {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex: 1 1 auto;
      overflow: hidden;
    }

    .shift-table {
      background: #b3e5ff;
      border-radius: 6px;
      padding: 6px;
      flex: 1;
      min-width: 45%;
      box-shadow: 0 0 8px #00bfff88;
      text-align: center;
      display: flex;
      flex-direction: column;
      height: 100%;
      color: #003366;
      overflow: hidden;
    }

    .shift-table h3 {
      margin: 3px 0 6px;
      font-size: 13px;
      color: #0077cc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      background: #e6f7ff;
      flex: 1 1 auto;
      color: #003366;
      overflow: hidden;
    }

    thead th {
      background: #00bfff;
      padding: 4px;
      font-size: 11px;
      color: #003366;
      cursor: pointer;
      border-radius: 4px;
    }

    tbody td {
      padding: 3px 2px;
      text-align: center;
      border-bottom: 1px solid #00aaff;
    }

    tbody tr:nth-child(odd) {
      background-color: #cceeff;
    }

    tbody tr:last-child {
      background-color: #00bfff;
      font-weight: bold;
      color: #ffffff;
    }

    tbody tr:hover {
      background-color: #99e6ff;
    }
  </style>
</head>
<body>
  <!-- Password protection -->
  <script>
    var password = prompt("Enter password to access this site:");
    if (password !== "Blauda123") {
      document.body.innerHTML = "<h1>Access Denied</h1>";
      document.body.style.textAlign = "center";
    }
  </script>

  <h2>Agent Dashboard - Compact View</h2>
  <div id="lastUpdated"></div>
  <div style="text-align:center;">
    <select id="monthDropdown"></select>
  </div>

  <div class="top-row">
    <div id="topSok" class="metric-box"></div>
    <div id="topProfit" class="metric-box"></div>
    <div id="topCalls" class="metric-box"></div>
  </div>

  <div class="shift-container">
    <div class="shift-table">
      <h3>Morning Shift</h3>
      <div id="morningTable" style="flex:1 1 auto; overflow:auto;"></div>
    </div>
    <div class="shift-table">
      <h3>Night Shift</h3>
      <div id="nightTable" style="flex:1 1 auto; overflow:auto;"></div>
    </div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyYD7X2tEKE1YJZU8pEF1KNtW43dMh0Kg-kRr1NV7u5mJZnSBZq_7p6OBCb3X322z10ReriXHngSRq/pub?gid=1105455398&single=true&output=csv";
    
    const monthDropdown = document.getElementById('monthDropdown');
    const topSok = document.getElementById('topSok');
    const topProfit = document.getElementById('topProfit');
    const topCalls = document.getElementById('topCalls');
    const morningDiv = document.getElementById('morningTable');
    const nightDiv = document.getElementById('nightTable');
    const lastUpdated = document.getElementById('lastUpdated');
    
    let allData = [], headers = [], currentMonth = "ALL";
    let latestMonth = "ALL"; // Variable to hold the latest month

    async function loadData() {
      const response = await fetch(CSV_URL);
      const text = await response.text();
      processCSV(text);
      lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();
    }

    function processCSV(text) {
      const lines = text.trim().split('\n').map(parseCSVLine);
      headers = lines[0].map(h => h ? h.trim() : "");
      allData = lines.slice(1);
      populateMonths();
      displayData(currentMonth);
    }

    function parseCSVLine(line) {
      const result = [];
      let inQuotes = false, value = '';
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c == '"' && line[i + 1] == '"') {
          value += '"';
          i++;
        } else if (c == '"') inQuotes = !inQuotes;
        else if (c == ',' && !inQuotes) {
          result.push(value.trim());
          value = '';
        } else value += c;
      }
      result.push(value.trim());
      return result;
    }

    function populateMonths() {
      const monthIndex = headers.indexOf("Month");
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const monthPairs = Array.from(new Set(allData.map(row => {
        const raw = row[monthIndex];
        if (!raw) return null;
        
        let dateObj;
        if (!isNaN(Date.parse(raw))) dateObj = new Date(raw);
        else {
          const parts = raw.split(/[-\\/]/);
          if (parts.length >= 3) {
            const day = parseInt(parts[2]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[0]);
            dateObj = new Date(year, month, day);
          }
        }
        return dateObj ? monthNames[dateObj.getMonth()] : null;
      })).filter(Boolean));

      const uniqueMonths = Array.from(new Set(monthPairs));
      uniqueMonths.forEach(month => {
        const option = document.createElement('option');
        option.textContent = month;
        option.value = month;
        monthDropdown.appendChild(option);
      });

      latestMonth = uniqueMonths[uniqueMonths.length - 1];  // Latest available month
      monthDropdown.value = latestMonth;  // Set dropdown to latest month
    }

    function displayData(month) {
      const monthIndex = headers.indexOf("Month");
      const filteredData = allData.filter(row => row[monthIndex] === month || month === "ALL");
      updateTopMetrics(filteredData);
      populateShiftTables(filteredData);
    }

    function updateTopMetrics(data) {
      const sokTotal = data.reduce((sum, row) => sum + parseFloat(row[headers.indexOf("SOK")]) || 0, 0);
      const profitTotal = data.reduce((sum, row) => sum + parseFloat(row[headers.indexOf("Profit")]) || 0, 0);
      const callsTotal = data.reduce((sum, row) => sum + parseFloat(row[headers.indexOf("Calls")]) || 0, 0);

      topSok.innerHTML = `<div class="title">SOK</div><div class="value">${sokTotal.toFixed(2)}</div>`;
      topProfit.innerHTML = `<div class="title">Profit</div><div class="value">${profitTotal.toFixed(2)}</div>`;
      topCalls.innerHTML = `<div class="title">Calls</div><div class="value">${callsTotal.toFixed(0)}</div>`;
    }

    function populateShiftTables(data) {
      const morningData = data.filter(row => row[headers.indexOf("Shift")] === "Morning");
      const nightData = data.filter(row => row[headers.indexOf("Shift")] === "Night");

      morningDiv.innerHTML = generateShiftTable(morningData);
      nightDiv.innerHTML = generateShiftTable(nightData);
    }

    function generateShiftTable(shiftData) {
      const shiftTableHTML = `
        <table>
          <thead>
            <tr>
              <th>Agent</th>
              <th>SOK</th>
              <th>Profit</th>
              <th>Calls</th>
            </tr>
          </thead>
          <tbody>
            ${shiftData.map(row => `
              <tr>
                <td>${row[headers.indexOf("Agent")]}</td>
                <td>${parseFloat(row[headers.indexOf("SOK")]).toFixed(2)}</td>
                <td>${parseFloat(row[headers.indexOf("Profit")]).toFixed(2)}</td>
                <td>${parseFloat(row[headers.indexOf("Calls")]).toFixed(0)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      return shiftTableHTML;
    }

    monthDropdown.addEventListener('change', (e) => {
      currentMonth = e.target.value;
      displayData(currentMonth);
    });

    loadData();  // Initialize everything
  </script>
</body>
</html>
