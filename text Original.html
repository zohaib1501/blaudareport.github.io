<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Dashboard</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #001f3f; color: white; margin: 15px; user-select: none; font-size: 12px; }
  h2 { text-align: center; color: #00aaff; margin-bottom: 10px; font-size: 20px; }
  select { padding: 5px 10px; font-size: 12px; border-radius: 4px; border: 1px solid #00aaff; background: #002f5f; color: white; margin-bottom: 10px; }
  .dashboard-row { display: flex; justify-content: space-between; margin-bottom: 10px; gap: 10px; }
  .metric-box { background: #004080; border: 1px solid #00aaff; padding: 12px; border-radius: 8px; flex: 1; min-width: 180px; text-align: center; font-weight: bold; color: #a0e7ff; box-shadow: 0 0 10px #00aaff55; }
  .metric-box .title { color: #00e5ff; margin-bottom: 5px; font-size: 14px; }
  .metric-box .agent { font-size: 13px; margin: 2px 0; color: #ffffff; }
  .shift-container { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
  .shift-table { background: #00264d; border-radius: 6px; padding: 10px; flex: 1; min-width: 45%; box-shadow: 0 0 10px #00aaff88; text-align: center; }
  .shift-table h3 { margin: 6px 0 10px; font-size: 15px; color: #00c0ff; }
  table { width: 100%; border-collapse: collapse; font-size: 11.5px; background: #003366; }
  thead th { background: #005f9e; padding: 6px; font-size: 12px; color: white; cursor: pointer; }
  tbody td { padding: 5px 4px; text-align: center; border-bottom: 1px solid #004d80; }
  tbody tr:nth-child(odd) { background-color: #004080; }
  tbody tr:last-child { background-color: #005f9e; font-weight: bold; }
</style>
</head>
<body>
  <h2>Agent Dashboard - Compact View</h2>
  <div style="text-align:center;">
    <select id="monthDropdown"></select>
  </div>

  <div class="dashboard-row" id="topSok"></div>
  <div class="dashboard-row" id="topProfit"></div>
  <div class="dashboard-row" id="topCalls"></div>

  <div class="shift-container">
    <div class="shift-table">
      <h3>Morning Shift</h3>
      <div id="morningTable"></div>
    </div>
    <div class="shift-table">
      <h3>Night Shift</h3>
      <div id="nightTable"></div>
    </div>
  </div>

<script>
  // Your Google Sheets CSV link
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyYD7X2tEKE1YJZU8pEF1KNtW43dMh0Kg-kRr1NV7u5mJZnSBZq_7p6OBCb3X322z10ReriXHngSRq/pub?gid=1105455398&single=true&output=csv";
  // Free public CORS proxy (avoids browser blocking local fetch)
  const PROXY = "https://api.allorigins.win/raw?url=";

  const monthDropdown = document.getElementById('monthDropdown');
  const topSok = document.getElementById('topSok');
  const topProfit = document.getElementById('topProfit');
  const topCalls = document.getElementById('topCalls');
  const morningDiv = document.getElementById('morningTable');
  const nightDiv = document.getElementById('nightTable');

  let allData = [], headers = [], currentMonth = "ALL";

  async function loadData() {
    try {
      const response = await fetch(PROXY + encodeURIComponent(CSV_URL));
      const text = await response.text();
      processCSV(text);
    } catch (err) {
      console.error("Error loading CSV:", err);
    }
  }

  function processCSV(text) {
    const lines = text.trim().split('\n').map(parseCSVLine);
    headers = lines[0];
    allData = lines.slice(1);
    populateMonths();
    displayData(currentMonth);
  }

  function parseCSVLine(line) {
    const result = [];
    let inQuotes = false, value = '';
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"' && line[i+1] === '"') { value += '"'; i++; }
      else if (c === '"') inQuotes = !inQuotes;
      else if (c === ',' && !inQuotes) { result.push(value.trim()); value = ''; }
      else value += c;
    }
    result.push(value.trim());
    return result;
  }

  function formatMonth(m) {
    const d = new Date(m + "-01");
    return isNaN(d) ? m : d.toLocaleString("en-US", { month: "short", year: "2-digit" });
  }

  function populateMonths() {
    const monthIndex = headers.indexOf("Month");
    const months = Array.from(new Set(allData.map(row => row[monthIndex])));
    monthDropdown.innerHTML = `<option value="ALL">All Months</option>` + months.map(m => `<option value="${m}">${formatMonth(m)}</option>`).join('');
    monthDropdown.addEventListener("change", e => displayData(e.target.value));
  }

  function displayData(month) {
    currentMonth = month;
    const i = {
      month: headers.indexOf("Month"),
      agent: headers.indexOf("Sales Agent"),
      shift: headers.indexOf("Shift"),
      sok: headers.indexOf("SOK Count"),
      reserved: headers.indexOf("Reserved Count"),
      calls: headers.indexOf("Total Calls"),
      talk: headers.indexOf("Total Talktime"),
      profit: headers.indexOf("Estimated SOK Profit")
    };

    const data = month === "ALL" ? allData : allData.filter(r => r[i.month] === month);
    const grouped = { morning: {}, night: {} };
    const topData = {};

    data.forEach(r => {
      const agent = r[i.agent], shift = r[i.shift].toLowerCase().includes("morning") ? "morning" : "night";
      const sok = +r[i.sok] || 0, reserved = +r[i.reserved] || 0, calls = +r[i.calls] || 0, profit = +r[i.profit] || 0;
      let talk = 0;
      if (r[i.talk].includes(":")) {
        const t = r[i.talk].split(":").map(Number);
        talk = t.length === 3 ? t[0]*3600 + t[1]*60 + t[2] : t[0]*60 + t[1];
      } else talk = +r[i.talk] || 0;

      if (!grouped[shift][agent]) grouped[shift][agent] = { agent, sokTotal: 0, reservedTotal: 0, callsTotal: 0, talkTotal: 0, profitTotal: 0 };
      const g = grouped[shift][agent];
      g.sokTotal += sok; g.reservedTotal += reserved; g.callsTotal += calls; g.talkTotal += talk; g.profitTotal += profit;

      if (!topData[agent]) topData[agent] = { sokTotal: 0, callsTotal: 0, profitTotal: 0 };
      topData[agent].sokTotal += sok; topData[agent].callsTotal += calls; topData[agent].profitTotal += profit;
    });

    renderShift(Object.values(grouped.morning), morningDiv);
    renderShift(Object.values(grouped.night), nightDiv);
    renderTopBoxes(topData);
  }

  function renderShift(data, container) {
    const total = { sokTotal: 0, reservedTotal: 0, callsTotal: 0, talkTotal: 0, profitTotal: 0 };
    data.forEach(d => { for (let k in total) total[k] += d[k]; });
    data.push({ agent: "Grand Total", ...total });

    const keys = ["agent", "sokTotal", "reservedTotal", "callsTotal", "talkTotal", "profitTotal"];
    let html = "<table><thead><tr>" + keys.map(k => `<th>${k.replace("Total","")}</th>`).join('') + "</tr></thead><tbody>";
    data.forEach(d => {
      html += `<tr><td>${d.agent}</td><td>${d.sokTotal}</td><td>${d.reservedTotal}</td><td>${d.callsTotal}</td><td>${formatTime(d.talkTotal)}</td><td>¥${Math.round(d.profitTotal)}</td></tr>`;
    });
    html += "</tbody></table>";
    container.innerHTML = html;
  }

  function renderTopBoxes(data) {
    function buildBox(title, key) {
      const sorted = Object.entries(data).map(([agent, v]) => ({ agent, value: v[key] || 0 }))
        .sort((a,b) => b.value - a.value).slice(0,3);
      return `<div class="metric-box"><div class="title">Top by ${title}</div>` +
             sorted.map(t => `<div class="agent">${t.agent}: ${key==="profitTotal" ? "¥" : ""}${Math.round(t.value)}</div>`).join("") +
             `</div>`;
    }
    topSok.innerHTML = buildBox("SOK", "sokTotal");
    topProfit.innerHTML = buildBox("Profit", "profitTotal");
    topCalls.innerHTML = buildBox("Calls", "callsTotal");
  }

  function formatTime(sec) {
    if (!sec) return "00:00";
    const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
    return h ? `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}` : `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }

  loadData();
  setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
